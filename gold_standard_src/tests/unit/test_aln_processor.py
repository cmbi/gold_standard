from nose.tools import eq_, ok_

import gold_standard_src.gold_standard.aln_processor as ap


def test_find_positions_to_fill_in():
    aln_dict = {
            "4FDXA":  "PIIQMNLLEGRTVEQKRNAVAAITEAVVRTLDVRPDQVRILINELGVEHFSVAGQTAAMRQ",
            "3RY0A":  "PLIRVTLLEGRSPQEVAALGEALTAAAHETLGTPVEAVRVIVEETPPERWFVGGRSVAERR",
            "4X1CH":  "PIAQIHILEGRSDEQKETLIREVSEAISRSLDAPLTSVRVIITEMAKGHFGIGGELASKV-",
            "1MWWA":  "TVIEINLMAGRMEGTKKRLIKMLFSELEYKLGIRAHDVEITIKEQPAHCWGFRGMTG--EA",
            "3M21A":  "PFINIKLVpgPTNEQKQQLIEGVSDLMVKVLNKNKASIVVIIDEVDSNNYGLGGESVHHLR",
            "4FAZA":  "PFAQIYLIEGRTEEQKRAVIEKVTQAMMEAVGAPKENVRVWIHDVPKENWGIGGVSAKALG",
            "3MB2A":  "LLLRITMLEGRSTEQKAELARALSAAAAAAFDVPLAEVRLIIQEVPPTHWTVGGISMA-EL",
            "1OTFA":  "PIAQLYIIEGRTDEQKETLIRQVSEAMANSLDAPLERVRVLITEMPKNHFGIGGEPASK--",
            "2OPAA":  "PYVTVKMLEGRTDEQKRNLVEKVTEAVKETTGASEEKIVVFIEEMRKDHYAVAGKRLSDME",
    }
    aln_dict = {
        "4FDXA":  "PIIQMNLLEGRTVEQKRNAVAAITEAVVRTLDVRPDQVRILINELGVEHFSVAGQTAAMr",
        "3RY0A":  "PLIRVTLLEGRSPQEVAALGEALTAAAHETLGTPVEAVRVIVEETPPERWFVGGRSVAEr",
        "4X1CH":  "PIAQIHILEGRSDEQKETLIREVSEAISRSLDapLTSVRVIITEMAKGHFGIGGELASKv",
        "1MWWA":  "TVIEINLMAGRMEGTKKRLIKMLFSELEYKLGIRAHDVEITIKEQPAHCWGFRGMTG--e",
        "3M21A":  "PFINIKLVpgPTNEQKQQLIEGVSDLMVKVLNKNKASIVVIIDEVDSNNYGLGGESVHHl",
        "4FAZA":  "PFAQIYLIEGRTEEQKRAVIEKVTQAMMEAVGAPKENVRVWIHDVPKENWGIGGVSAKAl",
        "3MB2A":  "LLLRITMLEGRSTEQKAELARALSAAAAAAFDVPLAEVRLIIQEVPPTHWTVGGISMA-e",
        "1OTFA":  "PIAQLYIIEGRTDEQKETLIRQVSEAMANSLDAPLERVRVLITEMPKNHFGIGGEPASK-",
        "2OPAA":  "PYVTVKMLEGRTDEQKRNLVEKVTEAVKETTGASEEKIVVFIEEMRKDHYAVAGKRLSDm",
    }

    master_full_seq = "PIAQIHILEGRSDEQKETLIREVSEAISRSLDASPLTSVRVIITEMAKGHFGIGGELASKVRA"
    master_aln_seq = aln_dict["4X1CH"]

    positions_to_fill_in = ap.find_positions_to_fill_in(master_full_seq, master_aln_seq)
    eq_(positions_to_fill_in, [(33, 'S'), (60, 'R'), (60, 'A')])
    # eq_(positions_to_fill_in, [(33, 'S'), (60, 'R'), (61, 'A')])


def test_fill_in_gaps():
    aln_dict = {
        "4FDXA":  "PIIQMNLLEGRTVEQKRNAVAAITEAVVRTLDVRPDQVRILINELGVEHFSVAGQTAAMr",
        "3RY0A":  "PLIRVTLLEGRSPQEVAALGEALTAAAHETLGTPVEAVRVIVEETPPERWFVGGRSVAEr",
        "4X1CH":  "PIAQIHILEGRSDEQKETLIREVSEAISRSLDapLTSVRVIITEMAKGHFGIGGELASKv",
        "1MWWA":  "TVIEINLMAGRMEGTKKRLIKMLFSELEYKLGIRAHDVEITIKEQPAHCWGFRGMTG--e",
        "3M21A":  "PFINIKLVpgPTNEQKQQLIEGVSDLMVKVLNKNKASIVVIIDEVDSNNYGLGGESVHHl",
        "4FAZA":  "PFAQIYLIEGRTEEQKRAVIEKVTQAMMEAVGAPKENVRVWIHDVPKENWGIGGVSAKAl",
        "3MB2A":  "LLLRITMLEGRSTEQKAELARALSAAAAAAFDVPLAEVRLIIQEVPPTHWTVGGISMA-e",
        "1OTFA":  "PIAQLYIIEGRTDEQKETLIRQVSEAMANSLDAPLERVRVLITEMPKNHFGIGGEPASK-",
        "2OPAA":  "PYVTVKMLEGRTDEQKRNLVEKVTEAVKETTGASEEKIVVFIEEMRKDHYAVAGKRLSDm",
    }

    master_full_seq = "PIAQIHILEGRSDEQKETLIREVSEAISRSLDASPLTSVRVIITEMAKGHFGIGGELASKVRA"
    master_id = "4X1CH"
    master_aln_seq = aln_dict[master_id]

    positions_to_fill_in = ap.find_positions_to_fill_in(master_full_seq, master_aln_seq)
    eq_(positions_to_fill_in, [(33, 'S'), (60, 'R'), (60, 'A')])

    ap.fill_in_gaps(aln_dict, positions_to_fill_in, master_id, master_full_seq)

    expected = {
        "4FDXA":  "PIIQMNLLEGRTVEQKRNAVAAITEAVVRTLDV-RPDQVRILINELGVEHFSVAGQTAAMr--",
        "3RY0A":  "PLIRVTLLEGRSPQEVAALGEALTAAAHETLGT-PVEAVRVIVEETPPERWFVGGRSVAEr--",
        "4X1CH":  "PIAQIHILEGRSDEQKETLIREVSEAISRSLDASPLTSVRVIITEMAKGHFGIGGELASKVRA",
        "1MWWA":  "TVIEINLMAGRMEGTKKRLIKMLFSELEYKLGI-RAHDVEITIKEQPAHCWGFRGMTG--e--",
        "3M21A":  "PFINIKLVpgPTNEQKQQLIEGVSDLMVKVLNK-NKASIVVIIDEVDSNNYGLGGESVHHl--",
        "4FAZA":  "PFAQIYLIEGRTEEQKRAVIEKVTQAMMEAVGA-PKENVRVWIHDVPKENWGIGGVSAKAl--",
        "3MB2A":  "LLLRITMLEGRSTEQKAELARALSAAAAAAFDV-PLAEVRLIIQEVPPTHWTVGGISMA-e--",
        "1OTFA":  "PIAQLYIIEGRTDEQKETLIRQVSEAMANSLDA-PLERVRVLITEMPKNHFGIGGEPASK---",
        "2OPAA":  "PYVTVKMLEGRTDEQKRNLVEKVTEAVKETTGA-SEEKIVVFIEEMRKDHYAVAGKRLSDm--",
    }

    # eq_(aln_dict, expected)
    for i, seq in expected.iteritems():
        eq_(seq, aln_dict[i])


def test_remove_positions():

    aln_dict = {
        "4FDXA":  "PIIQMNLLEGRTVEQKRNAVAAITEAVVRTLDVRPDQVRILINELGVEHFSVAGQTAAMRQ",
        "3RY0A":  "PLIRVTLLEGRSPQEVAALGEALTAAAHETLGTPVEAVRVIVEETPPERWFVGGRSVAERR",
        "4X1CH":  "PIA-IHILEGRSDEQKETLIREVSEAISRSLDapLTSVRVIITEMAKGHFGIGGELASKV-",
        "1MWWA":  "TVIEINLMAGRMEGTKKRLIKMLFSELEYKLGIRAHDVEITIKEQPAHCWGFRGMTG--EA",
        "3M21A":  "PFINIKLVpgPTNEQKQQLIEGVSDLMVKVLNKNKASIVVIIDEVDSNNYGLGGESVHHLR",
        "4FAZA":  "PFAQIYLIEGRTEEQKRAVIEKVTQAMMEAVGAPKENVRVWIHDVPKENWGIGGVSAKALG",
        "3MB2A":  "LLLRITMLEGRSTEQKAELARALSAAAAAAFDVPLAEVRLIIQEVPPTHWTVGGISMA-EL",
        "1OTFA":  "PIAQLYIIEGRTDEQKETLIRQVSEAMANSLDAPLERVRVLITEMPKNHFGIGGEPASK--",
        "2OPAA":  "PYVTVKMLEGRTDEQKRNLVEKVTEAVKETTGASEEKIVVFIEEMRKDHYAVAGKRLSDME",
    }

    master_id = "4X1CH"
    positions_to_remove = ap.find_positions_to_remove(aln_dict[master_id])
    ap.remove_positions(aln_dict, positions_to_remove)

    expected = {
        "4FDXA":  "PIimNLLEGRTVEQKRNAVAAITEAVVRTLDVRPDQVRILINELGVEHFSVAGQTAAMr",
        "3RY0A":  "PLivTLLEGRSPQEVAALGEALTAAAHETLGTPVEAVRVIVEETPPERWFVGGRSVAEr",
        "4X1CH":  "PIaiHILEGRSDEQKETLIREVSEAISRSLDapLTSVRVIITEMAKGHFGIGGELASKv",
        "1MWWA":  "TViiNLMAGRMEGTKKRLIKMLFSELEYKLGIRAHDVEITIKEQPAHCWGFRGMTG--e",
        "3M21A":  "PFiiKLVpgPTNEQKQQLIEGVSDLMVKVLNKNKASIVVIIDEVDSNNYGLGGESVHHl",
        "4FAZA":  "PFaiYLIEGRTEEQKRAVIEKVTQAMMEAVGAPKENVRVWIHDVPKENWGIGGVSAKAl",
        "3MB2A":  "LLliTMLEGRSTEQKAELARALSAAAAAAFDVPLAEVRLIIQEVPPTHWTVGGISMA-e",
        "1OTFA":  "PIalYIIEGRTDEQKETLIRQVSEAMANSLDAPLERVRVLITEMPKNHFGIGGEPASK-",
        "2OPAA":  "PYvvKMLEGRTDEQKRNLVEKVTEAVKETTGASEEKIVVFIEEMRKDHYAVAGKRLSDm",
    }

    eq_(aln_dict, expected)
